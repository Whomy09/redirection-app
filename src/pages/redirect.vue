<script lang="ts" setup>
import { onMounted, ref } from 'vue'
import { useRoute, useRouter } from 'vue-router'
import { Redirection } from '@/services/models/redirection'

const route = useRoute()
const router = useRouter()

const redirectionName = route.params.name as string

const links = ref<string[]>([])

function getRandomLink() {
  const randomIndex = Math.floor(Math.random() * links.value.length)
  return links.value[randomIndex]
}

function redirectUser() {
  const link = getRandomLink()
  const linkElement = document.createElement('a')
  linkElement.href = link
  linkElement.click()
}

async function getRedirection() {
  return await new Redirection().getByName(redirectionName)
}

async function handleRedirectUser() {
  try {
    const redirection = await getRedirection()

    if (redirection.status === 'INACTIVE') {
      router.push({ name: 'inactive-redirect' })
      return
    }

    links.value = redirection.links
    redirectUser()
  } catch (error) {
    router.push({ name: 'wrong-redirect' })
  }
}

onMounted(async () => {
  await handleRedirectUser()
})
</script>

<template>
  <div class="h-screen w-screen flex justify-center items-center">
    <h1>Redirecting...</h1>
  </div>
</template>
